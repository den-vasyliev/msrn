version: 2

general:
  build_dir: src
  
jobs:
  build:
    docker:
      - image: perl:5.26

    steps:
      - checkout
      
      - run:
          working_directory: src
          command: |
            /usr/local/bin/cpanm Carton
            /usr/local/bin/carton install
      - run:
          working_directory: src
          command: |
            /usr/local/bin/carton exec pp msrn.pl -o /tmp/artifacts/msrn.bin
   
      # Deploy staging
#      - deploy:
#          command: |
#            if [ "${CIRCLE_BRANCH}" == "staging" ];
#              then ansible-playbook site.yml -i staging;
#            fi

      # Deploy production
#     - deploy:
#          command: |
#            if [ "${CIRCLE_BRANCH}" == "master" ];
#              then ansible-playbook site.yml -i production;
#            fi

      # Save artifacts
      - store_artifacts:
          path: /tmp/artifacts
          destination: build

  notify:
    webhooks:
      - url: 
        curl -H "Content-Type: application/json" --data '{"source_type": "Branch", "source_name": "staging"}' -X POST https://registry.hub.docker.com/u/msrn/msrn-pre-prod/trigger/7c5439d1-0017-4763-8252-e17e26f9025b/ 

      # Upload test results
#      - store_test_results:
#         path: /tmp/test-reports